<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visualizador de Branches e Commits do GitHub</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    h1 {
      color: #333;
    }
    .container {
      text-align: center;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    input {
      padding: 10px;
      width: 300px;
      margin-bottom: 20px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 15px;
      border: none;
      background-color: #28a745;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f2f2f2;
    }
    .commits {
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Visualizador de Branches e Commits do GitHub</h1>
    <input type="text" id="repoInput" placeholder="Digite o usuário/repositório (ex: facebook/react)" />
    <button onclick="fetchBranches()">Buscar Branches</button>
    <div id="commitTable"></div>
  </div>

  <script>
    let lastCommitSha = {}; // Armazena o SHA do último commit por branch

    // Função para buscar branches do repositório
    async function fetchBranches() {
      const repoInput = document.getElementById('repoInput').value;
      const commitTable = document.getElementById('commitTable');
      commitTable.innerHTML = ''; // Limpa a tabela

      if (!repoInput) {
        alert('Por favor, insira um repositório válido');
        return;
      }

      try {
        const response = await fetch(`https://api.github.com/repos/${repoInput}/branches`);
        if (!response.ok) {
          throw new Error('Repositório não encontrado ou API rate limit atingido');
        }

        const branches = await response.json();

        // Verifica se o repositório tem branches
        if (branches.length === 0) {
          commitTable.innerHTML = '<p>Não há branches neste repositório.</p>';
          return;
        }

        // Coloca o branch "main" na primeira coluna
        branches.sort((a, b) => (a.name === "main" ? -1 : b.name === "main" ? 1 : 0));

        // Cria a tabela de commits
        let table = `<table><thead><tr>`;
        branches.forEach(branch => {
          table += `<th>${branch.name}</th>`;
          lastCommitSha[branch.name] = ''; // Inicia o SHA do último commit como vazio
        });
        table += `</tr></thead><tbody><tr>`;

        // Cria uma linha para cada branch
        for (let branch of branches) {
          table += `<td><ul id="commits-${branch.name}" class="commits"><li>Carregando commits...</li></ul></td>`;
          fetchCommits(repoInput, branch.name); // Busca os commits e insere na célula correspondente
        }

        table += `</tr></tbody></table>`;
        commitTable.innerHTML = table;

        // Loop para verificar novos commits a cada 60 segundos
        setInterval(() => {
          branches.forEach(branch => {
            checkNewCommits(repoInput, branch.name);
          });
        }, 60000); // 60 segundos

      } catch (error) {
        alert('Erro ao buscar branches: ' + error.message);
      }
    }

    // Função para buscar commits de uma branch
    async function fetchCommits(repo, branch) {
      const commitList = document.getElementById(`commits-${branch}`);
      commitList.innerHTML = ''; // Limpa a lista de commits

      try {
        const response = await fetch(`https://api.github.com/repos/${repo}/commits?sha=${branch}`);
        if (!response.ok) {
          throw new Error('Erro ao buscar commits ou limite da API atingido');
        }

        const commits = await response.json();

        // Verifica se há commits no branch
        if (commits.length === 0) {
          commitList.innerHTML = '<li>Sem commits neste branch.</li>';
          return;
        }

        // Salva o SHA do último commit
        lastCommitSha[branch] = commits[0].sha;

        // Exibe os commits na lista dentro da célula correspondente
        commits.forEach(commit => {
          const li = document.createElement('li');
          li.textContent = `${commit.commit.message} - ${commit.commit.author.name} (${new Date(commit.commit.author.date).toLocaleDateString()})`;
          commitList.appendChild(li); // Insere cada commit na lista
        });

      } catch (error) {
        commitList.innerHTML = `<li>Erro ao carregar commits: ${error.message}</li>`;
      }
    }

    // Função para verificar novos commits em um branch
    async function checkNewCommits(repo, branch) {
      const commitList = document.getElementById(`commits-${branch}`);

      try {
        const response = await fetch(`https://api.github.com/repos/${repo}/commits?sha=${branch}`);
        if (!response.ok) {
          throw new Error('Erro ao buscar novos commits ou limite da API atingido');
        }

        const commits = await response.json();

        // Verifica se há novos commits
        if (commits.length > 0 && commits[0].sha !== lastCommitSha[branch]) {
          // Adiciona novos commits à lista
          const newCommits = commits.filter(commit => commit.sha !== lastCommitSha[branch]);
          newCommits.reverse().forEach(commit => {
            const li = document.createElement('li');
            li.textContent = `${commit.commit.message} - ${commit.commit.author.name} (${new Date(commit.commit.author.date).toLocaleDateString()})`;
            commitList.prepend(li); // Adiciona o commit no topo da lista
          });

          // Atualiza o SHA do último commit
          lastCommitSha[branch] = commits[0].sha;
        }

      } catch (error) {
        console.error(`Erro ao verificar novos commits no branch ${branch}: ${error.message}`);
      }
    }
  </script>
</body>
</html>

